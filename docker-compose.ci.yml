services:
  lint:
    build:
      context: .
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - CARGO_HOME=/tmp/cargo
      - CARGO_TARGET_DIR=/tmp/target
    command: |
      sh -c "
        rustup component list --installed &&
        cargo fmt --check &&
        cargo clippy --no-deps -- -D warnings &&
        cargo check
      "

  test:
    build:
      context: .
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - RUST_LOG=error
      - CI=true
      - CARGO_HOME=/tmp/cargo
      - CARGO_TARGET_DIR=/tmp/target
    command: |
      sh -c "
        cargo test --release
      "

  build-release:
    build:
      context: .
      target: builder
    volumes:
      - .:/app
      - ./artifacts:/artifacts
    working_dir: /app
    environment:
      - CARGO_HOME=/tmp/cargo
      - CARGO_TARGET_DIR=/tmp/target
    command: |
      sh -c "
        cargo build --release &&
        mkdir -p /artifacts &&
        cp /tmp/target/release/opencli /artifacts/ &&
        strip /artifacts/opencli
      "

  security-audit:
    build:
      context: .
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - CARGO_HOME=/tmp/cargo
      - CARGO_TARGET_DIR=/tmp/target
    command: |
      sh -c "
        cargo install cargo-audit &&
        cargo audit
      "

  integration-test:
    build:
      context: .
      target: runtime
    volumes:
      - opencli-config:/home/opencli/.config/opencli
    user: opencli
    working_dir: /home/opencli
    entrypoint: ["sh"]
    environment:
      - HOME=/home/opencli
      - USER=opencli
    command: |
      -c "
        echo 'main() {}' > gamemode.pwn &&
        opencli setup --force &&
        opencli install compiler &&
        opencli package install Y-Less/sscanf --target components &&
        opencli build --verbose &&
        opencli package list
      "

  benchmark:
    build:
      context: .
      target: builder
    volumes:
      - .:/app
    working_dir: /app
    environment:
      - CARGO_HOME=/tmp/cargo
      - CARGO_TARGET_DIR=/tmp/target
    command: cargo bench

volumes:
  opencli-config:
